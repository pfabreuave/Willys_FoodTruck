const foodItem= [
    
  {
      id: 1,
      name: '(P) Passarinho + Batata',
      category : 'Frango Passarinho',
      rating : 4.3,
      price: 26,
      img: 'images/frango/passar_Bat_p.jpg',
      quantity: 1
  },
  {
      id: 2,
      name: '(M) Passarinho + Batata',
      category : 'Frango Passarinho',
      rating : 4.3,
      price: 35,
      img: 'images/frango/passar_Bat_m.jpg',
      quantity: 1
  },
  {
      id: 3,
      name: '(G) Passarinho + Batata',
      category : 'Frango Passarinho',
      rating : 4.3,
      price: 50,
      img: 'images/frango/passar_Bat_p.jpg',
      quantity: 1
  },
  {
      id: 4,
      name: '(MG) Passarinho + Batata',
      category : 'Frango Passarinho',
      rating : 4.3,
      price: 60,
      img: 'images/frango/passar_Bat_Mega.jpg',
      quantity: 1
  },
  {
      id: 5,
      name: '(Fml) Passarinho + Batata',
      category : 'Frango Passarinho',
      rating : 4.3,
      price: 87,
      img: 'images/frango/passar_Bat_Mega.jpg',
      quantity: 1
  },
  {
      id: 6,
      name: '(FW) Passarinho + Batata',
      category : 'Frango Passarinho',
      rating : 4.3,
      price: 158,
      img: 'images/frango/passar_Bat_Mega.jpg',
      quantity: 1
  },
  {
      id: 7,
      name: '(P) Passarinho Solo, +- 6 pedaços',
      category : 'Frango Passarinho',
      rating : 4.3,
      price: 27,
      img: 'images/frango/passar_p.jpg',
      quantity: 1
  },
  {
      id: 8,
      name: '(M) Passarinho Solo, +- 10 pedaços',
      category : 'Frango Passarinho',
      rating : 4.3,
      price: 37,
      img: 'images/frango/passar_m.jpg',
      quantity: 1
  },
  {
      id: 9,
      name: '(G) Passarinho Solo, +- 14 pedaços',
      category : 'Frango Passarinho',
      rating : 4.3,
      price: 50,
      img: 'images/frango/passar_g.jpg',
      quantity: 1
  },
  {
      id: 10,
      name: '(P) File de Frango Empanado + Batata   ',
      category : 'Frango',
      rating : 4.3,
      price: 26,
      img: 'images/frango/emp_bat.jpg',
      quantity: 1
  },
  {
      id: 11,
      name: '(M) File de Frango Empanado + Batata   ',
      category : 'Frango',
      rating : 4.3,
      price: 35,
      img: 'images/frango/emp_bat.jpg',
      quantity: 1
  },
  {
      id: 12,
      name: '(G) File de Frango Empanado + Batata   ',
      category : 'Frango',
      rating : 4.3,
      price: 50,
      img: 'images/frango/emp_bat.jpg',
      quantity: 1
  },
  {
      id: 13,
      name: '(MEGA) File de Frango Empanado + Batata   ',
      category : 'Frango',
      rating : 4.3,
      price: 60,
      img: 'images/frango/emp_bat.jpg',
      quantity: 1
  },
  {
      id: 14,
      name: '(FAMILY) File de Frango Empanado + Batata   ',
      category : 'Frango',
      rating : 4.3,
      price: 87,
      img: 'images/frango/emp_bat.jpg',
      quantity: 1
  },
  {
      id: 15,
      name: '(P) File de Frango Empanado Solo, 250gr',
      category : 'Frango',
      rating : 4.3,
      price: 22,
      img: 'images/frango/file_empanado.jpg',
      quantity: 1
  },
  {
      id: 16,
      name: '(M) File de Frango Empanado Solo, 500gr',
      category : 'Frango',
      rating : 4.3,
      price: 37,
      img: 'images/frango/file_empanado.jpg',
      quantity: 1
  },
  {
      id: 17,
      name: '(G) File de Frango Empanado Solo, 1KG',
      category : 'Frango',
      rating : 4.3,
      price: 52,
      img: 'images/frango/file_empanado.jpg',
      quantity: 1
  },
  
  {
      id: 18,
      name: 'BACON',
      category : 'ADICIONAIS',
      rating : 4.3,
      price: 7,
      img: 'images/frango/bacon.jpg',
      quantity: 1
  },
  {
      id: 19,
      name: 'CALABRESA',
      category : 'ADICIONAIS',
      rating : 4.3,
      price: 7,
      img: 'images/frango/calabresa.jpg',
      quantity: 1
  },
  {
      id: 20,
      name: 'MUSSARELA',
      category : 'ADICIONAIS',
      rating : 4.3,
      price: 7,
      img: 'images/frango/mussarela.jpg',
      quantity: 1
  },
  {
      id: 21,
      name: 'CHEDDAR',
      category : 'ADICIONAIS',
      rating : 4.3,
      price: 7,
      img: 'images/frango/cheddar.jpg',
      quantity: 1
  },
  {
      id: 22,
      name: 'BATATA',
      category : 'ADICIONAIS',
      rating : 4.3,
      price: 15,
      img: 'images/frango/batata.jpg',
      quantity: 1
  },
  {
      id: 23,
      name: 'AIPIM',
      category : 'ADICIONAIS',
      rating : 4.3,
      price: 15,
      img: 'images/frango/aipim.jpg',
      quantity: 1
  },
  {
      id: 24,
      name: 'POLENTA',
      category : 'ADICIONAIS',
      rating : 4.3,
      price: 15,
      img: 'images/frango/polenta.jpg',
      quantity: 1
  },
  {
      id: 25,
      name: 'Completona de Casa',
      category : 'PORCOES',
      rating : 4.3,
      price: 65,
      img: 'images/frango/frango_variado.jpg',
      quantity: 1
  },
  {
      id: 26,
      name: 'Mista da Casa 1',
      category : 'PORCOES',
      rating : 4.3,
      price: 37,
      img: 'images/frango/frango_variado.jpg',
      quantity: 1
  },
  {
      id: 27,
      name: 'Mista da Casa 2',
      category : 'PORCOES',
      rating : 4.3,
      price: 50,
      img: 'images/frango/frango_variado.jpg',
      quantity: 1
  },
  {
      id: 28,
      name: 'Contra-file Grill PREMIUM 1',
      category : 'PORCOES',
      rating : 4.3,
      price: 62,
      img: 'images/frango/file_grill.png',
      quantity: 1
  },
  {
      id: 29,
      name: 'Contra-file Grill PREMIUM 2',
      category : 'PORCOES',
      rating : 4.3,
      price: 52,
      img: 'images/frango/file_grill.png',
      quantity: 1
  
  },
  {
      id: 30,
      name: 'Contra-file Grill Acebolado',
      category : 'PORCOES',
      rating : 4.3,
      price: 40,
      img: 'images/frango/file_grill.png',
      quantity: 1
  },
  {
      id: 31,
      name: 'Calabresa Acebolada',
      category : 'PORCOES',
      rating : 4.3,
      price: 23,
      img: 'images/frango/calabresa.jpg',
      quantity: 1
  
  },
  {
      id: 32,
      name: 'Fritas Cheddar & Bacon',
      category : 'PORCOES',
      rating : 4.3,
      price: 25,
      img: 'images/frango/papas-fritas-con-queso-cheddar.jpg',
      quantity: 1
  
  },
  {
      id: 33,
      name: 'Bolinho de Queijo (12 U)',
      category : 'PORCOES',
      rating : 4.3,
      price: 25,
      img: 'images/frango/bolinha-de-queijo.jpeg',
      quantity: 1
  },
  {
      id: 34,
      name: 'Porcao de Polenta(500gr)',
      category : 'PORCOES',
      rating : 4.3,
      price: 22,
      img: 'images/frango/polenta.jpg',
      quantity: 1
  },
  {
      id: 35,
      name: 'Porcao de Aipim(500gr)',
      category : 'PORCOES',
      rating : 4.3,
      price: 22,
      img: 'images/frango/aipim.jpg',
      quantity: 1
  },
  {
      id: 36,
      name: 'HAMBURGUER ESPECIAL',
      category : 'LANCHES',
      rating : 4.3,
      price: 12,
      img: 'images/hamburguer/hamburguer.jpg',
      quantity: 1
  },
  {
      id: 37,
      name: 'MISTO QUENTE',
      category : 'LANCHES',
      rating : 4.3,
      price: 11,
      img: 'images/hamburguer/misto_quente.jpg',
      quantity: 1
  },
  {
      id: 38,
      name: 'X-BURGER',
      category : 'LANCHES',
      rating : 4.3,
      price: 14,
      img: 'images/hamburguer/x-burguer.jpg',
      quantity: 1
  },
  {
      id: 38,
      name: 'X-EGG',
      category : 'LANCHES',
      rating : 4.3,
      price: 15,
      img: 'images/hamburguer/x-egg.jpg',
      quantity: 1
  },
  {
      id: 39,
      name: 'X-BACON',
      category : 'LANCHES',
      rating : 4.3,
      price: 16,
      img: 'images/hamburguer/x-bacon.jpg',
      quantity: 1
  },
  {
      id: 40,
      name: 'X-CALABRESA',
      category : 'LANCHES',
      rating : 4.3,
      price: 16,
      img: 'images/hamburguer/x-calabresa.jpg',
      quantity: 1
  },
  {
      id: 41,
      name: 'X-EGG CALABRESA',
      category : 'LANCHES',
      rating : 4.3,
      price: 18,
      img: 'images/hamburguer/x-egg-calabresa.jpg',
      quantity: 1
  },
  {
      id: 42,
      name: 'X-TUDO',
      category : 'LANCHES',
      rating : 4.3,
      price: 20,
      img: 'images/hamburguer/x-tudo.jpg',
      quantity: 1
  },
  {
      id: 43,
      name: 'X-TUDO DUPLO',
      category : 'LANCHES',
      rating : 4.3,
      price: 26,
      img: 'images/hamburguer/x-tudo.jpg',
      quantity: 1
  },
  {
      id: 44,
      name: 'X-FRANGO',
      category : 'LANCHES',
      rating : 4.3,
      price: 16,
      img: 'images/hamburguer/x-frango.jpg',
      quantity: 1
  },
  {
      id: 45,
      name: 'X-EGG FRANGO',
      category : 'LANCHES',
      rating : 4.3,
      price: 17,
      img: 'images/hamburguer/x-egg-frango.png',
      quantity: 1
  },
  {
      id: 46,
      name: 'X-EGG FRANGO ESPECIAL',
      category : 'LANCHES',
      rating : 4.3,
      price: 19,
      img: 'images/hamburguer/x-egg-frango-esp.jpg',
      quantity: 1
  },
  {
      id: 47,
      name: 'WILLYS TRIPLO FRIES',
      category : 'LANCHES',
      rating : 4.3,
      price: 35,
      img: 'images/frango/Contra-file.jpg',
      quantity: 1
  },
  {
      id: 48,
      name: 'X-CONTRA-FILE',
      category : 'LANCHES',
      rating : 4.3,
      price: 23,
      img: 'images/frango/Contra-file.jpg',
      quantity: 1
  },
  {
      id: 49,
      name: 'X-TUDO CONTRA-FILE',
      category : 'LANCHES',
      rating : 4.3,
      price: 28,
      img: 'images/frango/Contra-file.jpg',
      quantity: 1
  },
  {
      id: 50,
      name: 'COCA/SABORES LATA',
      category : 'BEBIDAS',
      rating : 4.3,
      price: 6,
      img: 'images/bebidas/COCA-SABORES-LATA.jpg',
      quantity: 1
  },
  {
      id: 51,
      name: 'COCA/SABORES 600ML',
      category : 'BEBIDAS',
      rating : 4.3,
      price: 8,
      img: 'images/bebidas/COCA-SABORES-LATA.jpg',
      quantity: 1
  },
  {
      id: 52,
      name: 'COCA-COLA/SABORES 1,5LT',
      category : 'BEBIDAS',
      rating : 4.3,
      price: 11,
      img: 'images/bebidas/coca-cola-1-5l.jpg',
      quantity: 1
  },
  {
      id: 53,
      name: 'COCA-COLA/SABORES 2LT',
      category : 'BEBIDAS',
      rating : 4.3,
      price: 13,
      img: 'images/bebidas/coca_cola_2l.jpg',
      quantity: 1
  },
  {
      id: 54,
      name: 'AGUA NATURAL',
      category : 'BEBIDAS',
      rating : 4.3,
      price: 3,
      img: 'images/bebidas/agua-natural.jpg',
      quantity: 1
  },
  {
      id: 55,
      name: 'AGUA COM GAS',
      category : 'BEBIDAS',
      rating : 4.3,
      price: 4,
      img: 'images/bebidas/agua-com-gas.jpg',
      quantity: 1
  },
  {
      id: 56,
      name: 'CERVEJA BRAHMA LATAO',
      category : 'BEBIDAS',
      rating : 4.3,
      price: 8,
      img: 'images/bebidas/cerveja-brahma-latao.jpg',
      quantity: 1
  },
  {
      id: 57,
      name: 'CERVEJA DEVASSA LATAO',
      category : 'BEBIDAS',
      rating : 4.3,
      price: 8,
      img: 'images/bebidas/devassa-latao.jpg',
      quantity: 1
  },
  {
      id: 58,
      name: 'CERVEJA BRAHMA LONG NECK',
      category : 'BEBIDAS',
      rating : 4.3,
      price: 8,
      img: 'images/bebidas/brahma-long-neck.jpg',
      quantity: 1
  },
  {
      id: 59,
      name: 'CERVEJA BUDWEISER LOG NECK',
      category : 'BEBIDAS',
      rating : 4.3,
      price: 10,
      img: 'images/bebidas/budweiser-log-neck.jpg',
      quantity: 1
  },
  {
      id: 60,
      name: 'CERVEJA CORONA LONG NECK',
      category : 'BEBIDAS',
      rating : 4.3,
      price: 12,
      img: 'images/bebidas/corona-long-neck.jpg',
      quantity: 1
  },
  {
      id: 61,
      name: 'CERVEJA HEINEKEIN LONG NECK',
      category : 'BEBIDAS',
      rating : 4.3,
      price: 10,
      img: 'images/bebidas/Heinecken_LongNeck.png',
      quantity: 1
  },
  {
      id: 62,
      name: 'ENERGETICO MONSTER LATAO',
      category : 'BEBIDAS',
      rating : 4.3,
      price: 16,
      img: 'images/bebidas/monster-energy.png',
      quantity: 1
  },
  {
      id: 63,
      name: 'ENERGETICO BUL LATAO',
      category : 'BEBIDAS',
      rating : 4.3,
      price: 20,
      img: 'images/bebidas/Energetitico-RedBull.jpg',
      quantity: 1
  },
]

var numeroComanda2 = 0;
var comandElement = document.getElementById("comand");

document.addEventListener("DOMContentLoaded", function() {
    const foodTable = document.getElementById("foodTable");
    var acumulador = 0;
    var item_acumulador = 0;
    const totalElement = document.querySelector(".total");
    const cantItemsElement = document.querySelector(".cantItems");
    const comandElement = document.querySelector(".comand");
    const downloadCSVButton = document.getElementById("downloadCSVButton");

    // Botón para obtener y almacenar los valores
    document.getElementById("refreshButton").addEventListener("click", function() {
        location.reload();
    });

    // Consultar el Local Storage para obtener el último número de comanda
    var lastPedidoNumber = parseInt(localStorage.getItem("lastPedido")) || 0;

    // Función para actualizar el número de comanda en localStorage
    function actualizarNumeroComanda() {
        lastPedidoNumber++;
        localStorage.setItem("lastPedido", lastPedidoNumber);
        return lastPedidoNumber;
    }

    // Generación de filas dinámicamente
    for (let i = 0; i < foodItem.length; i++) {
        var newRow = document.createElement("tr");

        newRow.innerHTML = `
            <td><input autofocus type="number" class="inputField cantidadInput" style="width:40px;"></td>
            <td><img src="${foodItem[i].img}" alt="Imagen del artículo seleccionado" style="width: 50px; height: 30px;"></td>
            <td>${foodItem[i].id}</td>
            <td>${foodItem[i].name}</td>
            <td>R$${foodItem[i].price}</td>
        `;

        // Agrega la nueva fila a la tabla
        foodTable.appendChild(newRow);
    }

    // Función para almacenar el pedido en localStorage
    function storeOrder() {
        
        // Mostrar el número de comanda en el campo de input
        //comandElement.textContent = ("("+ lastPedidoNumber + ")");
        const inputFields = document.querySelectorAll(".cantidadInput");
        let orderList = []; // Lista de productos seleccionados

        inputFields.forEach(function(inputField, index) {
            const cantidad = parseInt(inputField.value);
            
            if (cantidad > 0) {
                const precioTotal = foodItem[index].price * cantidad;
                acumulador += precioTotal;
                item_acumulador += cantidad;

                const orderItem = {
                    id: foodItem[index].id,
                    name: foodItem[index].name,
                    category: foodItem[index].category,
                    rating: foodItem[index].rating,
                    price: foodItem[index].price,
                    img: foodItem[index].img,
                    quantity: foodItem[index].quantity,
                    comanda: lastPedidoNumber, // Mismo número de comanda para todos los productos
                    cantidad: cantidad,
                    dispositivo: navigator.hardwareConcurrency, // Número de núcleos de CPU
                    //fechaHora: new Date().toLocaleString(),
                    fechaHora: new Date().toLocaleString().replace(",", "").replace(/\//g, "-").replace(/ /g, "_"), // Corregir formato de fecha y hora
                    precioTotal: precioTotal.toFixed(2),
                    rating: foodItem[index].rating
                };

                orderList.push(orderItem);
            }
        });

        if (orderList.length > 0) {
            localStorage.setItem(`pedido_${lastPedidoNumber}`, JSON.stringify(orderList));
            //localStorage.setItem("orderList", JSON.stringify(orderList));
            //console.log(`Pedido ${lastPedidoNumber} almacenado en local storage:`, orderList);
            totalElement.innerHTML = acumulador.toFixed(2);
            cantItemsElement.innerHTML = item_acumulador;
            comandElement.innerHTML = lastPedidoNumber;
            //alert(`Comanda ${lastPedidoNumber},  ${item_acumulador} item, R$ ${acumulador.toFixed(2)} almacenado en local storage:`, orderList);
        } else {
            alert("No se ha seleccionado ningún producto.");
        }
    }

    // Botón para obtener y almacenar los valores
    const getValuesButton = document.getElementById("getValuesButton");
    getValuesButton.addEventListener("click", function() {
        lastPedidoNumber = actualizarNumeroComanda(); // Actualiza el número de comanda antes de almacenar
        storeOrder(); // Almacena los productos seleccionados
        numeroComanda2 =  lastPedidoNumber;
        enviarComanda()
        location.reload();
    });

    // Función para limpiar el localStorage (asociada al botón de limpiar)
    const btnClearStorage = document.querySelector("#btnClearStorage");
    btnClearStorage.addEventListener("click", () => {
        clearStorage();
    });

    // Función para descargar los pedidos como archivo CSV
    downloadCSVButton.addEventListener("click", function() {
        // Recuperar todas las comandas del localStorage
        let pedidos = [];
        for (let i = 0; i < localStorage.length; i++) {
            let key = localStorage.key(i);
            if (key.startsWith('pedido_')) {
                let pedido = JSON.parse(localStorage.getItem(key));
                pedidos.push(...pedido); // Agregar los ítems del pedido a la lista general
            }
        }

        // Ordenar los pedidos por número de comanda
        pedidos.sort((a, b) => b.comanda - a.comanda);

        // Crear el CSV
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Comanda,ID,Nome,Categoria,Quantidade,Preço unitário,Preço total,Data e hora,Dispositivo\n"; // Encabezado del CSV
        pedidos.forEach(item => {
            let row = [
                item.comanda,
                item.id,
                item.name,
                item.category,
                item.cantidad,
                item.price,
                item.precioTotal,
                item.fechaHora,
                item.dispositivo
            ].join(",");
            csvContent += row + "\n";
        });

        // Crear un elemento de enlace para descargar el archivo CSV
        let encodedUri = encodeURI(csvContent);
        
        // Obtener la fecha y hora actuales para la etiqueta del archivo
        let now = new Date();
        let fechaHora = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}-${now.getMinutes().toString().padStart(2, '0')}-${now.getSeconds().toString().padStart(2, '0')}`;
        
        let link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `comandas_${fechaHora}.csv`);
        document.body.appendChild(link);

        // Hacer clic automáticamente en el enlace para iniciar la descarga
        link.click();
        
        // Eliminar el enlace después de la descarga
        document.body.removeChild(link);
        alert('descarga concluida')
    });

    function clearStorage() {
        localStorage.clear();
        alert("Todos los registros de localStorage han sido eliminados.");
    }
});

  